<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matriz GE-McKinsey Dinámica - Editor Universal</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="header">
    <div class="editable-title">
      <h1 id="main-title" onclick="editTitle('main-title')">🏢 Matriz GE-McKinsey Dinámica - Carvajal S.A.</h1>
      <input type="text" id="main-title-edit" class="title-edit" onblur="saveTitle('main-title')" onkeypress="saveTitleOnEnter(event, 'main-title')">
    </div>
    <div class="editable-title">
      <div class="subtitle" id="subtitle" onclick="editTitle('subtitle')">Análisis Estratégico del Portfolio Tecnológico • Versión 2024-2027</div>
      <input type="text" id="subtitle-edit" class="title-edit" onblur="saveTitle('subtitle')" onkeypress="saveTitleOnEnter(event, 'subtitle')">
    </div>
  </div>

  <div class="main-container">
    <div class="control-panel">
      <!-- Factores Internos -->
      <div class="section">
        <h3>🏢 Factores Internos (Fortalezas)</h3>
        <table id="internal-factors">
          <thead>
            <tr>
              <th>Factor</th>
              <th>Peso (%)</th>
              <th><button class="btn btn-success" onclick="addInternalFactor()">+ Factor</button></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" value="Liderazgo Tecnológico" onchange="updateMatrix()"></td>
              <td><input type="number" class="factor-weight" value="25" min="1" max="100" onchange="updateWeights('internal')"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)">🗑️</button></td>
            </tr>
            <tr>
              <td><input type="text" value="Disponibilidad Plataformas" onchange="updateMatrix()"></td>
              <td><input type="number" class="factor-weight" value="20" min="1" max="100" onchange="updateWeights('internal')"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)">🗑️</button></td>
            </tr>
            <tr>
              <td><input type="text" value="Base de Clientes B2B" onchange="updateMatrix()"></td>
              <td><input type="number" class="factor-weight" value="20" min="1" max="100" onchange="updateWeights('internal')"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)">🗑️</button></td>
            </tr>
            <tr>
              <td><input type="text" value="Experiencia Regional" onchange="updateMatrix()"></td>
              <td><input type="number" class="factor-weight" value="15" min="1" max="100" onchange="updateWeights('internal')"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)">🗑️</button></td>
            </tr>
            <tr>
              <td><input type="text" value="Capacidad de Innovación" onchange="updateMatrix()"></td>
              <td><input type="number" class="factor-weight" value="20" min="1" max="100" onchange="updateWeights('internal')"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)">🗑️</button></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <th>Total Peso:</th>
              <th id="internal-total" style="color: #28a745;">100%</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Factores Externos -->
      <div class="section">
        <h3>🌍 Factores Externos (Atractivo)</h3>
        <table id="external-factors">
          <thead>
            <tr>
              <th>Factor</th>
              <th>Peso (%)</th>
              <th><button class="btn btn-success" onclick="addExternalFactor()">+ Factor</button></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" value="Transformación Digital" onchange="updateMatrix()"></td>
              <td><input type="number" class="factor-weight" value="30" min="1" max="100" onchange="updateWeights('external')"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)">🗑️</button></td>
            </tr>
            <tr>
              <td><input type="text" value="Crecimiento Fintech" onchange="updateMatrix()"></td>
              <td><input type="number" class="factor-weight" value="25" min="1" max="100" onchange="updateWeights('external')"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)">🗑️</button></td>
            </tr>
            <tr>
              <td><input type="text" value="Regulaciones Favorables" onchange="updateMatrix()"></td>
              <td><input type="number" class="factor-weight" value="20" min="1" max="100" onchange="updateWeights('external')"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)">🗑️</button></td>
            </tr>
            <tr>
              <td><input type="text" value="Demanda B2B Colombia" onchange="updateMatrix()"></td>
              <td><input type="number" class="factor-weight" value="25" min="1" max="100" onchange="updateWeights('external')"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)">🗑️</button></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <th>Total Peso:</th>
              <th id="external-total" style="color: #28a745;">100%</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Productos/UEN -->
      <div class="section">
        <h3>📊 Productos/Unidades de Negocio</h3>
        <button class="btn btn-success" onclick="addProduct()" style="margin-bottom: 10px;">+ Agregar Producto</button>
        <div id="products-container" style="max-height: 200px; overflow-y: auto;">
          <!-- Los productos se cargarán dinámicamente -->
        </div>
      </div>

      <!-- Fechas Personalizables -->
      <div class="section">
        <h3>📅 Fechas de Análisis</h3>
        <table>
          <thead>
            <tr>
              <th>Período</th>
              <th>Fecha</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="dates-table">
            <tr>
              <td><input type="text" value="Actual" onchange="updateDateLabels()"></td>
              <td><input type="date" value="2024-01-01" onchange="updateDateLabels()"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)">🗑️</button></td>
            </tr>
            <tr>
              <td><input type="text" value="Año 1" onchange="updateDateLabels()"></td>
              <td><input type="date" value="2025-01-01" onchange="updateDateLabels()"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)">🗑️</button></td>
            </tr>
            <tr>
              <td><input type="text" value="Año 2" onchange="updateDateLabels()"></td>
              <td><input type="date" value="2026-01-01" onchange="updateDateLabels()"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)">🗑️</button></td>
            </tr>
            <tr>
              <td><input type="text" value="Año 3" onchange="updateDateLabels()"></td>
              <td><input type="date" value="2027-01-01" onchange="updateDateLabels()"></td>
              <td><button class="btn btn-danger" onclick="removeRow(this)">🗑️</button></td>
            </tr>
          </tbody>
        </table>
        <button class="btn btn-success" onclick="addDatePeriod()">+ Agregar Fecha</button>
      </div>

      <!-- Controles -->
      <div class="section">
        <h3>🎛️ Controles</h3>
        <div class="controls">
          <button class="btn" onclick="showAllYears()">📊 Ver Todos</button>
          <button class="btn btn-secondary" onclick="exportMatrix()">💾 Exportar</button>
          <button class="btn" onclick="showProjectionModal()">⏭️ Proyecciones</button>
          <button class="btn btn-secondary" onclick="animateMovements()">🎬 Animar</button>
        </div>
        <div class="year-filter" id="year-filter">
          <!-- Los botones de filtro se generarán dinámicamente -->
        </div>
      </div>

      <!-- Selector de Color -->
      <div class="section">
        <h3>🎨 Colores de Productos</h3>
        <div class="color-picker-section">
          <h4>Producto Seleccionado: <span id="selected-product-name">Ninguno</span></h4>
          <div class="color-palette">
            <div class="color-option" style="background: #10b981" data-color="#10b981" title="Verde - Invertir/Crecer"></div>
            <div class="color-option" style="background: #f59e0b" data-color="#f59e0b" title="Amarillo - Selectividad"></div>
            <div class="color-option" style="background: #ef4444" data-color="#ef4444" title="Rojo - Cosechar/Retirar"></div>
            <div class="color-option" style="background: #3b82f6" data-color="#3b82f6" title="Azul"></div>
            <div class="color-option" style="background: #8b5cf6" data-color="#8b5cf6" title="Púrpura"></div>
            <div class="color-option" style="background: #06b6d4" data-color="#06b6d4" title="Cian"></div>
            <div class="color-option" style="background: #f97316" data-color="#f97316" title="Naranja"></div>
            <div class="color-option" style="background: #84cc16" data-color="#84cc16" title="Lima"></div>
            <div class="color-option" style="background: #ec4899" data-color="#ec4899" title="Rosa"></div>
            <div class="color-option" style="background: #6b7280" data-color="#6b7280" title="Gris"></div>
          </div>
          <div class="custom-color-input">
            <label>Color personalizado:</label>
            <input type="color" id="custom-color" value="#2c5aa0">
            <button class="btn" onclick="applyCustomColor()">Aplicar</button>
          </div>
          <p style="font-size: 10px; color: #666; margin-top: 10px;">
            💡 Haz clic en un producto de la matriz y luego selecciona un color para cambiarlo
          </p>
        </div>
      </div>

      <div class="legend">
        <h4 style="margin-top: 0; color: #2c5aa0">🗝️ Leyenda</h4>
        <div class="legend-item">
          <div class="legend-color" style="background: #10b981"></div>
          <span>Invertir/Crecer</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #f59e0b"></div>
          <span>Selectividad</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #ef4444"></div>
          <span>Cosechar/Retirar</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #94a3b8; border: 2px dashed #666"></div>
          <span>Proyección futura</span>
        </div>
      </div>
    </div>

    <div class="matrix-container">
      <svg id="matrix-svg" viewBox="0 0 1000 600"></svg>
    </div>
  </div>

  <!-- Tooltip -->
  <div id="tooltip" class="tooltip"></div>

  <!-- Modal -->
  <div id="projectionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin: 0; color: #2c5aa0">⏭️ Editar Proyecciones Estratégicas</h3>
        <span class="close" onclick="closeProjectionModal()">×</span>
      </div>
      <div id="projectionForm" class="projection-form"></div>
      <div style="text-align: right; margin-top: 20px">
        <button class="btn" onclick="saveProjections()">💾 Guardar</button>
        <button class="btn btn-secondary" onclick="closeProjectionModal()">❌ Cancelar</button>
      </div>
    </div>
  </div>

  <!-- JavaScript al final -->
  <script>
    let currentFilter = 'Actual';
    let selectedProductIndex = -1;
    let products = []; // ✅ Inicialización obligatoria

    const svg = document.getElementById('matrix-svg');
    const tooltip = document.getElementById('tooltip');
    const MARGIN = 80;
    const WIDTH = 1000 - 2 * MARGIN;
    const HEIGHT = 600 - 2 * MARGIN;

    // Funciones básicas de inicialización - stubs que serán implementadas en script.js
    function initializeMatrix() {
      console.log('Inicializando matriz...');
      if (typeof loadProductsTable === 'function') loadProductsTable();
      if (typeof updateDateLabels === 'function') updateDateLabels();
      if (typeof updateWeights === 'function') {
        updateWeights('internal');
        updateWeights('external');
      }
      if (typeof drawMatrix === 'function') drawMatrix();
      if (typeof setupColorPicker === 'function') setupColorPicker();
    }

    // Stubs para las funciones que están en script.js
    function editTitle(titleId) { console.log('editTitle:', titleId); }
    function saveTitle(titleId) { console.log('saveTitle:', titleId); }
    function saveTitleOnEnter(event, titleId) { console.log('saveTitleOnEnter:', titleId); }
    function addInternalFactor() { console.log('addInternalFactor'); }
    function addExternalFactor() { console.log('addExternalFactor'); }
    function removeRow(button) { console.log('removeRow'); }
    function updateMatrix() { console.log('updateMatrix'); }
    function updateWeights(type) { console.log('updateWeights:', type); }
    function addProduct() { console.log('addProduct'); }
    function updateDateLabels() { console.log('updateDateLabels'); }
    function addDatePeriod() { console.log('addDatePeriod'); }
    function showAllYears() { console.log('showAllYears'); }
    function exportMatrix() { console.log('exportMatrix'); }
    function showProjectionModal() { console.log('showProjectionModal'); }
    function animateMovements() { console.log('animateMovements'); }
    function applyCustomColor() { console.log('applyCustomColor'); }
    function closeProjectionModal() { console.log('closeProjectionModal'); }
    function saveProjections() { console.log('saveProjections'); }

    // Ejecutar al cargar
    window.onload = initializeMatrix;
  </script>
  <script src="script.js"></script> <!-- Archivo con todas las funciones implementadas -->
</body>
</html>